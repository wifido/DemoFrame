<!DOCTYPE html>
<html lang="en" class="app">
<head>
    <meta charset="utf-8"/>
    <title>内部组件</title>
    <meta name="description"
          content="app, web app, responsive, admin dashboard, admin, flat, flat ui, ui kit, off screen nav"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <link rel="stylesheet" href="js/jPlayer/jplayer.flat.css" type="text/css"/>
    <link rel="stylesheet" href="css/bootstrap.css" type="text/css"/>
    <link rel="stylesheet" href="css/animate.css" type="text/css"/>
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css"/>
    <link rel="stylesheet" href="css/simple-line-icons.css" type="text/css"/>
    <link rel="stylesheet" href="css/font.css" type="text/css"/>
    <link rel="stylesheet" href="css/app.css" type="text/css"/>
    <link rel="stylesheet" href="css/editormd.min.css" type="text/css"/>
    <link rel="stylesheet" href="plugins/jQueryUI/jquery-ui.min.css" type="text/css"/>
    <link rel="stylesheet" href="plugins/bootstrap3-fileinput/css/fileinput.min.css" type="text/css"/>

    <link rel="stylesheet" href="css/customize.css" type="text/css"/>
    <!--[if lt IE 9]>
    <script src="js/ie/html5shiv.js"></script>
    <script src="js/ie/respond.min.js"></script>
    <script src="js/ie/excanvas.js"></script>
    <![endif]-->
</head>
<body class="">
<section class="vbox">
    <header class="bg-white-only header header-md navbar navbar-fixed-top-xs">
        <div class="navbar-header aside bg-info ">
            <a class="btn btn-link visible-xs" data-toggle="class:nav-off-screen,open" data-target="#nav,html">
                <i class="icon-list"></i>
            </a>
            <a href="index.html" class="navbar-brand text-lt">
                <i class="icon-folder"></i>
                <span class="hidden-nav-xs m-l-sm">SFPP</span>
            </a>
            <a class="btn btn-link visible-xs" data-toggle="dropdown" data-target=".user">
                <i class="icon-settings"></i>
            </a>
        </div>
        <ul class="nav navbar-nav hidden-xs">
            <li>
                <a href="#nav,.navbar-header" data-toggle="class:nav-xs,nav-xs" class="text-muted active">
                    <i class="fa fa-indent text"></i>
                    <i class="fa fa-dedent text-active"></i>
                </a>
            </li>
        </ul>
        <form class="navbar-form navbar-left input-s-lg m-t m-l-n-xs hidden-xs" role="search">
            <div class="form-group">
                <div class="input-group">
            <span class="input-group-btn">
              <button type="submit" class="btn btn-sm bg-white btn-icon rounded"><i class="fa fa-search"></i></button>
            </span>
                    <input type="text" class="form-control input-sm no-border rounded"
                           placeholder="搜索本站">
                </div>
            </div>
        </form>
        <div class="navbar-right ">
            <ul class="nav navbar-nav m-n hidden-xs nav-user user">

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle bg clear" data-toggle="dropdown">
              <span class="thumb-sm avatar pull-right m-t-n-sm m-b-n-sm m-l-sm">
                <img src="images/a0.png" alt="...">
              </span>
                        <userNo></userNo>
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu animated fadeInRight">
                        <li>
                            <a href="../logout">Logout</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </header>
    <section>
        <section class="hbox stretch">
            <!-- .aside -->
            <aside class="bg-black dk aside hidden-print" id="nav">
                <section class="vbox">
                    <section class="w-f-md scrollable">
                        <div class="slim-scroll" data-height="auto" data-disable-fade-out="true" data-distance="0"
                             data-size="10px" data-railOpacity="0.2">


                            <!-- nav -->
                            <nav class="nav-primary hidden-xs">
                                <ul class="nav bg clearfix">
                                    <li class="hidden-nav-xs padder m-t m-b-sm text-xs text-muted">
                                        版块
                                    </li>
                                    <li>
                                        <a href="index.html" data-transition="pop">
                                            <i class="icon-home icon text-success"></i>
                                            <span class="font-bold">主页</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="internal.html" data-transition="pop">
                                            <i class="icon-grid icon text-info"></i>
                                            <span class="font-bold">内部组件</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="pcompTitle.html" data-transition="pop">
                                            <i class="icon-drawer icon text-primary-lter"></i>
                                            <span class="font-bold">开放软件</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" data-transition="pop">
                                            <i class="icon-graduation icon  text-info-dker"></i>
                                            <span class="font-bold">技术学院</span>
                                        </a>
                                    </li>
                                    <li class="m-b hidden-nav-xs"></li>
                                </ul>
                            </nav>
                            <!-- / nav -->
                        </div>
                    </section>

                </section>
            </aside>
            <!-- /.aside -->
            <section id="content">
                <section class="hbox stretch">
                    <section>
                        <section class="vbox">
                            <section class="scrollable padder-lg w-f-md" id="bjax-target">

                            </section>
                        </section>
                    </section>
                    <!-- / side content -->
                </section>
                <a href="#" class="hide nav-off-screen-block" data-toggle="class:nav-off-screen,open"
                   data-target="#nav,html"></a>
            </section>
        </section>
    </section>
</section>
<script src="js/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.js"></script>
<!-- App -->
<script src="js/app.js"></script>
<script src="js/slimscroll/jquery.slimscroll.min.js"></script>
<script src="js/masonry/tiles.min.js"></script>
<script src="js/masonry/demo.js"></script>
<script src="js/app.plugin.js"></script>
<script type="text/javascript" src="js/jPlayer/jquery.jplayer.min.js"></script>
<script type="text/javascript" src="js/jPlayer/add-on/jplayer.playlist.min.js"></script>
<script type="text/javascript" src="js/jPlayer/demo.js"></script>


<script type="text/javascript" src="js/sfpp-native/util.js"></script>
<script type="text/javascript" src="js/sfpp-native/user.js"></script>
<script type="text/javascript" src="js/sfpp-native/pcomp.js"></script>
<script type="text/javascript" src="js/sfpp-native/pcompform.js"></script>
<script type="text/javascript" src="js/sfpp-native/search.js"></script>
<script type="text/javascript" src="js/editormd.min.js"></script>
<script src="js/jquery-form.js"></script>
<script src="js/ajaxfileupload.js"></script>
<script src="lib/raphael.min.js"></script>
<script src="lib/underscore.min.js"></script>
<script src="lib/sequence-diagram.min.js"></script>
<script src="lib/flowchart.min.js"></script>
<script src="lib/jquery.flowchart.min.js"></script>
<script src="lib/prettify.min.js"></script>
<script src="lib/marked.min.js"></script>
<script src="plugins/jQueryUI/jquery-ui.min.js"></script>
<script src="plugins/bootstrap3-fileinput/js/fileinput.min.js"></script>
<script>
    $(document).ready(function initialize() {
        $("userNo").html(($.user.get()).userNo);
        var matrix_item_2 = "<a href=\"";
        var matrix_item_3 = "\"><img src=\"";
        var matrix_item_4 = "\" alt=\"\" class=\"r r-2x img-full\"></a></div><div class=\"padder-v\"><a href=\"";
        var matrix_item_5 = "\" class=\"text-ellipsis\" style=\"text-align:center\">";
        var matrix_item_6 = "</a></div></div></div>";
        var matrix_item_7 = "<div class=\"col-xs-6 col-sm-4 col-md-3 col-lg-2\" style='display: none'><div class=\"item\"><div class=\"pos-rlt\">";

        var pcompTitle = $.pcomp.title.get("0000000000000000000000000000000000000000");
        var pcompKinds = $.pcomp.kind.getByTitleName(pcompTitle.name);
        var isPcompAdmin = $.pcomp.userRight.getIsPcompAdmin();
        var content = $("#bjax-target");
        content.empty();
        content.append($("<h1>内部组件-<small>内部标准组件和内部维护组件</small></h1><hr/>"));
        if (isPcompAdmin) {
            content.append($("<button class='btn btn-info btn-rounded kind'>增加新内部组件分类</button>"));
            $("button[class*=btn][class*=btn-info][class*=btn-rounded][class*=kind]").click(function () {
                var dialogDiv = $("[role=dialog]");
                var id = this.id;
                dialogDiv.remove();
                var dialog = $(dialog_str);
                dialog.attr("title", "添加分类");
                var label = $("<h4></h4>");
                label.html("所属主题：<b>" + pcompTitle.name + "</b>");
                dialog.append(label);
                label = $(label_str);
                label.html("请输入新分类名称（不为空）：");
                dialog.append(label);
                var kindNameInput = $(pcomp_kind_name_textInput_str);
                dialog.append(kindNameInput);
                label = $(label_str);
                label.html("请输入新分类简介（不为空）：");
                dialog.append(label);
                var notNullText = $(notNull_textInput_str);
                dialog.append(notNullText);
                label = $(label_str);
                label.html("请为此分类上传一个头像（不为空）：");
                dialog.append(label);
                var notNullFile = $(notNull_fileInput_str);
                notNullFile.attr("name", "pcomp_kind_top_photo");
                notNullFile.attr("id", "pcomp_kind_top_photo");
                dialog.append(notNullFile);
                notNullFile.fileinput();
                dialog.dialog({
                    autoOpen: false,
                    minWidth: 400,
                    minHeight: 400,
                    show: {effect: "blind", duration: 1000},
                    hide: {effect: "explode", duration: 1000},
                    modal: true,
                    buttons: {
                        "提交修改": function () {
                            if (validatePcomp(pcompTitle.name)) {
                                $.pcomp.kind.add(pcompTitle.name, kindNameInput[0].value, notNullText[0].value, initialize);
                                $(this).dialog("close");
                            }
                        },
                        "取消": function () {
                            $(this).dialog("close");
                        }
                    }
                });
                dialog.dialog("open");
            });
        }
        for (ii = 0; ii < pcompKinds.length; ii++) {
            var a = $("<a href='#' class='pull-right text-muted m-t-lg' id='" + ii + "'><i class='icon-refresh i-lg  inline'></i></a>");
            var h2 = "<h2 class='font-thin m-b'><span class='thumb-sm avatar m-t-n-sm m-b-n-sm m-l-sm'><img src='" + pcompKinds[ii].topPhoto + "'></span>" + pcompKinds[ii].name;
            h2 += "<span class='musicbar animate inline m-l-sm' style='width:20px;height:20px'><span class='bar1 a1 bg-primary lter'></span><span class='bar2 a2 bg-info lt'></span><span class='bar3 a3 bg-success'></span><span class='bar4 a4 bg-warning dk'></span><span class='bar5 a5 bg-danger dker'></span></span>";

            if ($.pcomp.userRight.getHasModifyKindRight(pcompKinds[ii].id)) {
                h2 += "<button class='btn btn-success btn-rounded kind'id='" + ii + "'>修改本分类</button><button class='btn btn-danger btn-rounded kind'id='" + ii + "'>删除本分类</button>";
            }
            if ($.pcomp.userRight.getHasAddSoftwareRight(pcompKinds[ii].id)) {
                h2 += "<button class='btn btn-info btn-rounded software' id='" + ii + "'>添加新软件</button>";
            }
            h2 += "</h2>";
            h2 = $(h2);
            var div = $("<div class='row row-sm'></div>");
            var pcompSoftwares = $.pcomp.software.getAllByKind(pcompKinds[ii].id, 1);
            div.html(getSoftwares(ii,pcompSoftwares));
            content.append(a);
            content.append(h2);
            content.append(div);
            content.append($(getSoftwaresPage(ii,pcompSoftwares)));
            $("a[class*="+pcompKinds[ii].id+"]").click(function(){
                var id = $(this).parent().parent().parent().parent().prev().prev().prev()[0].id;
                var pageNum = this.id;
                var div = $(this).parent().parent().parent().parent().prev();
                updateSoftwares(id,div,pageNum);
            });
        }
        $("i[class*=icon-refresh]").click(function () {
            var id = $(this).parent()[0].id;
            var div = $(this).parent().next().next();
            updateSoftwares(id,div,1);
            $("a[class*="+pcompKinds[id].id+"]").click(function(){
                var id = $(this).parent().parent().parent().parent().prev().prev().prev()[0].id;
                var pageNum = this.id;
                var div = $(this).parent().parent().parent().parent().prev();
                updateSoftwares(id,div,pageNum);
            });
        });
        function updateSoftwares(id,div,pageNumber){
            div.empty();
            var pcompSoftwares = $.pcomp.software.getAllByKind(pcompKinds[id].id, pageNumber);
            div.html(getSoftwares(id,pcompSoftwares));
            div.next().remove();
            div.after($(getSoftwaresPage(id,pcompSoftwares)));
            blink();
        }
        function getSoftwares(id,pcompSoftwares){
            var html = "";
            for (j = 0; j < pcompSoftwares.list.length; j++) {
                html += matrix_item_7 + matrix_item_2 + getHtmlPath() + '/pcompSoftware.html?pcompSoftwareId=' + pcompSoftwares.list[j].id + matrix_item_3 + pcompSoftwares.list[j].avatar + matrix_item_4 + getHtmlPath() + '/pcompSoftware.html?pcompSoftwareId=' + pcompSoftwares.list[j].id + matrix_item_5 + pcompSoftwares.list[j].name + matrix_item_6;
            }

            return html;
        }
        function getSoftwaresPage(id,pcompSoftwares){
            var html="";
            html += "<div class='row row-sm'><div class='text-center'><ul class='pagination pagination'>";
            for (i = pcompSoftwares.firstPage; i <= pcompSoftwares.lastPage; i++) {
                html += "<li ";
                if (i == pcompSoftwares.pageNum) {
                    html += "class='active'"
                }
                html += "><a id='" + i + "' class='"+pcompKinds[id].id+"' \">" + i + "</a></li>";
            }
            html += "</ul></div></div>";
            return html;
        }
        blink();
        function blink() {
            var divs = $("div[class*=col-xs-6][class*=col-sm-4][class*=col-md-3][class*=col-lg-2]");
            for (i = 0; i < divs.length; i++) {
                if (i < 20) {
                    $(divs[i]).fadeIn(i * 250);
                } else {
                    $(divs[i]).fadeIn(5000);
                }
            }
        }

        $("button[class*=btn][class*=btn-success][class*=btn-rounded][class*=kind]").click(function () {
            var dialogDiv = $("[role=dialog]");
            var id = this.id;
            dialogDiv.remove();
            var dialog = $(dialog_str);
            dialog.attr("title", "修改分类");
            label = $(label_str);
            label.html("请输入新分类名称（不为空）：");
            dialog.append(label);
            var kindNameInput = $(notNull_textInput_str);
            kindNameInput.attr("value", pcompKinds[id].name);
            dialog.append(kindNameInput);
            label = $(label_str);
            label.html("请输入新分类简介（不为空）：");
            dialog.append(label);
            var notNullText = $(notNull_textInput_str);
            notNullText.attr("value", pcompKinds[id].introduction);
            dialog.append(notNullText);
            label = $(label_str);
            label.html("请为此分类上传一个头像（留空为不修改）：");
            dialog.append(label);
            var File = $(fileInput_str);
            File.attr("name", "pcomp_kind_top_photo");
            File.attr("id", "pcomp_kind_top_photo");
            dialog.append(File);
            File.fileinput();
            dialog.dialog({
                autoOpen: false,
                minWidth: 400,
                minHeight: 400,
                show: {effect: "blind", duration: 1000},
                hide: {effect: "explode", duration: 1000},
                modal: true,
                buttons: {
                    "提交修改": function () {
                        if (validatePcomp()) {
                            $.pcomp.kind.update(pcompKinds[id].id, kindNameInput[0].value, notNullText[0].value, initialize);
                            $(this).dialog("close");
                        }
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                }
            });
            dialog.dialog("open");
        });
        $("button[class*=btn][class*=btn-danger][class*=btn-rounded][class*=kind]").click(function () {
            var id = this.id;
            if (confirm("你确定要删除" + pcompKinds[id].name + "吗？")) {
                $.pcomp.kind.remove(pcompKinds[id].id)
            }
        });
        $("button[class*=btn][class*=btn-info][class*=btn-rounded][class*=software]").click(function () {
            var dialogDiv = $("[role=dialog]");
            var id = this.id;
            dialogDiv.remove();
            var dialog = $(dialog_str);
            dialog.attr("title", "添加内部组件");
            var label = $("<h4></h4>");
            label.html("所属分类：<b>" + pcompKinds[id].name + "</b>");
            dialog.append(label);
            label = $(label_str);
            label.html("请输入新内部组件名称（不为空）：");
            dialog.append(label);
            var softwareNameInput = $(pcomp_software_name_textInput_str);
            dialog.append(softwareNameInput);
            label = $(label_str);
            label.html("请为此内部组件上传一个头像（最好不为空）：");
            dialog.append(label);
            var File = $(notNull_fileInput_str);
            File.attr("name", "pcomp_software_avatar");
            File.attr("id", "pcomp_software_avatar");
            dialog.append(File);
            File.fileinput();
            label = $(label_str);
            label.html("请输入内部组件介绍：");
            dialog.append(label);
            var md = $(md_div);
            md.attr("id", "softwareIntroduction");
            dialog.append(md);
            dialog.dialog({
                autoOpen: false,
                minWidth: 800,
                minHeight: 600,
                maxHeight: 600,
                show: {effect: "blind", duration: 1000},
                hide: {effect: "explode", duration: 1000},
                modal: true,
                buttons: {
                    "提交修改": function () {
                        if (validatePcomp(pcompKinds[id].id)) {
                            $.pcomp.software.add(pcompKinds[id].id, softwareNameInput[0].value, mdEditorText.getMarkdown(), initialize);
                            $(this).dialog("close");
                        }
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                }
            });
            dialog.dialog("open");
            var mdEditorText = editormd("softwareIntroduction", editorMdEditing);
        });
    });
</script>
</body>
</html>